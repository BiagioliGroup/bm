<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================== -->
    <!-- VISTA GRID PRINCIPAL DE CASHFLOW - V18 COMPATIBLE -->
    <!-- ========================================== -->
    <record id="view_cashflow_projection_grid" model="ir.ui.view">
        <field name="name">cashflow.projection.grid</field>
        <field name="model">cashflow.projection</field>
        <field name="arch" type="xml">
            <grid string="Cashflow Proyectado - Vista Temporal"
                  create="true" edit="true" delete="true"
                  create_inline="true" display_empty="true"
                  editable="bottom">

                <!-- AGRUPACIÓN POR FILAS -->
                <field name="fiscal_type" type="row"/>
                <field name="type" type="row"/>
                <field name="partner_id" type="row"/>
                <field name="category_id" type="row"/>
                <field name="source_type" type="row"/>

                <!-- COLUMNAS TEMPORALES MEJORADAS -->
                <field name="date" type="col">
                    <!-- Vista diaria por defecto -->
                    <range name="day" string="Diario" span="day" step="day" default="1"/>
                    <!-- Vista semanal -->
                    <range name="week" string="Semanal" span="week" step="day"/>
                    <!-- Vista mensual -->
                    <range name="month" string="Mensual" span="month" step="day"/>
                    <!-- Vista trimestral -->
                    <range name="quarter" string="Trimestral" span="quarter" step="week"/>
                </field>

                <!-- MEDIDA PRINCIPAL -->
                <field name="amount" type="measure"/>
            </grid>
        </field>
    </record>

    <!-- ========================================== -->
    <!-- VISTA LISTA DE CASHFLOW -->
    <!-- ========================================== -->
    <record id="view_cashflow_projection_list" model="ir.ui.view">
        <field name="name">cashflow.projection.list</field>
        <field name="model">cashflow.projection</field>
        <field name="arch" type="xml">
            <list string="Proyecciones de Cashflow" 
                  decoration-success="type == 'ingreso'" 
                  decoration-danger="type == 'egreso'" 
                  decoration-muted="state == 'draft'"
                  decoration-info="state == 'realized'"
                  decoration-warning="source_type in ('supplier_invoice', 'customer_invoice')">
                
                <field name="date"/>
                <field name="name"/>
                <field name="partner_id"/>
                <field name="type"/>
                <field name="fiscal_type"/>
                <field name="source_type"/>
                <field name="amount" sum="Total"/>
                <field name="state" widget="badge" 
                       decoration-success="state == 'realized'"
                       decoration-info="state == 'confirmed'"
                       decoration-warning="state == 'projected'"
                       decoration-danger="state == 'cancelled'"/>
                <field name="payment_state" 
                       column_invisible="source_type not in ('supplier_invoice', 'customer_invoice')"/>
                <field name="actual_date" optional="hide"/>
                <field name="actual_amount" optional="hide"/>
                <field name="variance" optional="hide"/>
                <field name="account_move_id" optional="hide"/>
            </list>
        </field>
    </record>

    <!-- ========================================== -->
    <!-- VISTA KANBAN DE CASHFLOW -->
    <!-- ========================================== -->
    <record id="view_cashflow_projection_kanban" model="ir.ui.view">
        <field name="name">cashflow.projection.kanban</field>
        <field name="model">cashflow.projection</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state" class="o_kanban_small_column">
                <field name="id"/>
                <field name="name"/>
                <field name="partner_id"/>
                <field name="amount"/>
                <field name="date"/>
                <field name="type"/>
                <field name="fiscal_type"/>
                <field name="source_type"/>
                <field name="state"/>
                <field name="payment_state"/>
                <field name="account_move_id"/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_card">
                            <div class="oe_kanban_content">
                                <!-- HEADER CON TIPO -->
                                <div class="oe_kanban_details">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <field name="name"/>
                                            </strong>
                                            <br/>
                                            <span class="o_kanban_record_subtitle">
                                                <field name="partner_id"/>
                                            </span>
                                        </div>
                                        <div class="o_kanban_record_top_right">
                                            <span t-if="record.type.raw_value == 'ingreso'" 
                                                  class="badge text-bg-success">
                                                <i class="fa fa-arrow-up"/> Ingreso
                                            </span>
                                            <span t-if="record.type.raw_value == 'egreso'" 
                                                  class="badge text-bg-danger">
                                                <i class="fa fa-arrow-down"/> Egreso
                                            </span>
                                        </div>
                                    </div>

                                    <!-- INFORMACIÓN PRINCIPAL -->
                                    <div class="row mt-2">
                                        <div class="col-8">
                                            <strong class="h5">
                                                <field name="amount" widget="monetary"/>
                                            </strong>
                                        </div>
                                        <div class="col-4 text-end">
                                            <span t-if="record.fiscal_type.raw_value == 'white'" 
                                                  class="badge text-bg-success">Blanco</span>
                                            <span t-if="record.fiscal_type.raw_value == 'black'" 
                                                  class="badge text-bg-dark">Negro</span>
                                        </div>
                                    </div>

                                    <!-- FECHAS E INFORMACIÓN ADICIONAL -->
                                    <div class="mt-2">
                                        <div>
                                            <i class="fa fa-calendar me-1 text-muted"/>
                                            <field name="date"/>
                                        </div>
                                        <div t-if="record.payment_state.raw_value and record.payment_state.raw_value != 'not_applicable'">
                                            <i class="fa fa-credit-card me-1 text-muted"/>
                                            Pago: <field name="payment_state"/>
                                        </div>
                                    </div>

                                    <!-- BOTONES DE ACCIÓN -->
                                    <div class="mt-3">
                                        <button name="action_realize" type="object" 
                                                class="btn btn-sm btn-success me-2"
                                                invisible="state == 'realized'">
                                            <i class="fa fa-check"/> Realizar
                                        </button>
                                        <button name="action_view_related_invoice" type="object" 
                                                class="btn btn-sm btn-info me-2"
                                                invisible="not account_move_id">
                                            <i class="fa fa-external-link"/> Ver Factura
                                        </button>
                                        <button name="action_confirm" type="object" 
                                                class="btn btn-sm btn-primary"
                                                invisible="state != 'projected'">
                                            <i class="fa fa-thumbs-up"/> Confirmar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ========================================== -->
    <!-- VISTA PIVOT PARA ANÁLISIS -->
    <!-- ========================================== -->
    <record id="view_cashflow_projection_pivot" model="ir.ui.view">
        <field name="name">cashflow.projection.pivot</field>
        <field name="model">cashflow.projection</field>
        <field name="arch" type="xml">
            <pivot string="Análisis de Cashflow">
                <!-- FILAS POR DEFECTO -->
                <field name="fiscal_type" type="row"/>
                <field name="type" type="row"/>
                <field name="source_type" type="row"/>
                
                <!-- COLUMNAS POR DEFECTO -->
                <field name="date" interval="month" type="col"/>
                
                <!-- MEDIDAS -->
                <field name="amount" type="measure"/>
                <field name="actual_amount" type="measure"/>
                <field name="variance" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- ========================================== -->
    <!-- VISTA GRAPH PARA VISUALIZACIÓN -->
    <!-- ========================================== -->
    <record id="view_cashflow_projection_graph" model="ir.ui.view">
        <field name="name">cashflow.projection.graph</field>
        <field name="model">cashflow.projection</field>
        <field name="arch" type="xml">
            <graph string="Gráfico de Cashflow" type="line" stacked="False">
                <field name="date" interval="week"/>
                <field name="amount" type="measure"/>
                <field name="type"/>
                <field name="fiscal_type"/>
            </graph>
        </field>
    </record>

    <!-- ========================================== -->
    <!-- VISTA FORMULARIO DE CASHFLOW -->
    <!-- ========================================== -->
    <record id="view_cashflow_projection_form" model="ir.ui.view">
        <field name="name">cashflow.projection.form</field>
        <field name="model">cashflow.projection</field>
        <field name="arch" type="xml">
            <form string="Proyección de Cashflow">
                <header>
                    <button name="action_realize" type="object" string="Marcar como Realizado" 
                            class="btn-success" invisible="state == 'realized'"/>
                    <button name="action_confirm" type="object" string="Confirmar" 
                            class="btn-primary" invisible="state != 'projected'"/>
                    <button name="action_cancel" type="object" string="Cancelar" 
                            class="btn-secondary" invisible="state in ('realized', 'cancelled')"/>
                    <button name="action_view_related_invoice" type="object" string="Ver Factura Relacionada" 
                            class="btn-info" invisible="not account_move_id"/>
                    <field name="state" widget="statusbar" 
                           statusbar_visible="draft,projected,confirmed,realized"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Concepto del movimiento..."/>
                        </h1>
                    </div>
                    
                    <group>
                        <group name="basic_info" string="Información Básica">
                            <field name="date"/>
                            <field name="partner_id"/>
                            <field name="type"/>
                            <field name="category_id"/>
                        </group>
                        <group name="classification" string="Clasificación">
                            <field name="fiscal_type"/>
                            <field name="journal_type"/>
                            <field name="source_type"/>
                            <field name="amount"/>
                            <field name="currency_id" column_invisible="1"/>
                        </group>
                    </group>

                    <!-- INFORMACIÓN DE ORIGEN (FACTURAS) -->
                    <group name="source_info" string="Información de Origen" 
                           invisible="source_type not in ('supplier_invoice', 'customer_invoice', 'invoice')">
                        <group>
                            <field name="account_move_id" readonly="1"/>
                            <field name="payment_state" readonly="1"/>
                            <field name="amount_residual" readonly="1"/>
                        </group>
                        <group>
                            <field name="invoice_date_due" readonly="1"/>
                            <field name="source_reference" readonly="1"/>
                            <field name="payment_id" readonly="1"/>
                        </group>
                    </group>

                    <!-- PERÍODOS CALCULADOS -->
                    <group name="periods" string="Períodos Calculados" invisible="not date">
                        <field name="week" readonly="1"/>
                        <field name="month" readonly="1"/>
                        <field name="quarter" readonly="1"/>
                        <field name="year" readonly="1"/>
                    </group>

                    <!-- REALIZACIÓN -->
                    <group name="realization" string="Realización" invisible="state != 'realized'">
                        <group>
                            <field name="actual_date"/>
                            <field name="actual_amount"/>
                        </group>
                        <group>
                            <field name="variance" readonly="1"/>
                            <field name="variance_percent" widget="percentage" readonly="1"/>
                        </group>
                    </group>

                    <!-- INFORMACIÓN ADICIONAL -->
                    <group name="additional" string="Información Adicional">
                        <field name="subcategory"/>
                        <field name="tags"/>
                        <field name="source_id" invisible="not source_id" readonly="1"/>
                        <field name="notes"/>
                    </group>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ========================================== -->
    <!-- FILTROS Y BÚSQUEDAS -->
    <!-- ========================================== -->
    <record id="view_cashflow_projection_search" model="ir.ui.view">
        <field name="name">cashflow.projection.search</field>
        <field name="model">cashflow.projection</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="partner_id"/>
                <field name="category_id"/>
                <field name="account_move_id"/>
                
                <!-- FILTROS PREDEFINIDOS -->
                <filter name="ingresos" string="Ingresos" domain="[('type', '=', 'ingreso')]"/>
                <filter name="egresos" string="Egresos" domain="[('type', '=', 'egreso')]"/>
                <separator/>
                <filter name="en_blanco" string="En Blanco" domain="[('fiscal_type', '=', 'white')]"/>
                <filter name="en_negro" string="En Negro" domain="[('fiscal_type', '=', 'black')]"/>
                <separator/>
                <filter name="manual" string="Manuales" domain="[('source_type', '=', 'manual')]"/>
                <filter name="from_invoices" string="Desde Facturas" 
                        domain="[('source_type', 'in', ['supplier_invoice', 'customer_invoice', 'invoice'])]"/>
                <filter name="from_periodic" string="Gastos Periódicos" domain="[('source_type', '=', 'periodic')]"/>
                <separator/>
                
                <!-- FILTROS DE FECHA -->
                <filter name="current_week" string="Esta Semana" 
                        domain="[('date', '>=', (context_today() - relativedelta(days=context_today().weekday()))), ('date', '&lt;', (context_today() + relativedelta(days=7-context_today().weekday())))]"/>
                <filter name="current_month" string="Mes Actual" 
                        domain="[('date', '>=', (context_today().strftime('%Y-%m-01'))), ('date', '&lt;', ((context_today() + relativedelta(months=1)).strftime('%Y-%m-01')))]"/>
                <filter name="next_month" string="Próximo Mes" 
                        domain="[('date', '>=', ((context_today() + relativedelta(months=1)).strftime('%Y-%m-01'))), ('date', '&lt;', ((context_today() + relativedelta(months=2)).strftime('%Y-%m-01')))]"/>
                <filter name="current_quarter" string="Trimestre Actual" 
                        domain="[('date', '>=', (context_today().replace(month=((context_today().month-1)//3)*3+1, day=1))), ('date', '&lt;', ((context_today().replace(month=((context_today().month-1)//3)*3+1, day=1) + relativedelta(months=3))))]"/>
                <filter name="current_year" string="Año Actual" 
                        domain="[('date', '>=', context_today().strftime('%Y-01-01')), ('date', '&lt;=', context_today().strftime('%Y-12-31'))]"/>
                <separator/>
                
                <!-- FILTROS DE ESTADO -->
                <filter name="projected" string="Proyectado" domain="[('state', '=', 'projected')]"/>
                <filter name="confirmed" string="Confirmado" domain="[('state', '=', 'confirmed')]"/>
                <filter name="realized" string="Realizado" domain="[('state', '=', 'realized')]"/>
                <filter name="not_paid" string="Facturas No Pagadas" 
                        domain="[('payment_state', '=', 'not_paid')]"/>
                
                <!-- AGRUPACIONES -->
                <group expand="0" string="Agrupar por">
                    <filter name="group_type" string="Tipo" context="{'group_by': 'type'}"/>
                    <filter name="group_fiscal" string="Fiscal" context="{'group_by': 'fiscal_type'}"/>
                    <filter name="group_partner" string="Contacto" context="{'group_by': 'partner_id'}"/>
                    <filter name="group_category" string="Categoría" context="{'group_by': 'category_id'}"/>
                    <filter name="group_source" string="Origen" context="{'group_by': 'source_type'}"/>
                    <filter name="group_date" string="Fecha" context="{'group_by': 'date'}"/>
                    <filter name="group_month" string="Mes" context="{'group_by': 'date:month'}"/>
                    <filter name="group_week" string="Semana" context="{'group_by': 'date:week'}"/>
                    <filter name="group_state" string="Estado" context="{'group_by': 'state'}"/>
                    <filter name="group_payment_state" string="Estado de Pago" context="{'group_by': 'payment_state'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- ========================================== -->
    <!-- ACCIÓN PRINCIPAL DE CASHFLOW -->
    <!-- ========================================== -->
    <record id="action_cashflow_projection" model="ir.actions.act_window">
        <field name="name">Proyección de Cashflow</field>
        <field name="res_model">cashflow.projection</field>
    <field name="view_mode">list,kanban,pivot,graph,form</field>  <!-- ✅ SIN GRID -->
    <!-- <field name="view_id" ref="view_cashflow_projection_list"/> -->  <!-- ✅ SIN VIEW_ID FIJO -->
        <field name="domain">[]</field>
        <field name="context">{
            'search_default_current_month': 1,
            'default_state': 'projected'
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                ¡Planifica tu flujo de caja!
            </p>
            <p>
                Visualiza ingresos y egresos proyectados por día, semana o mes.<br/>
                • Separa movimientos en blanco y negro para un control completo<br/>
                • Importa automáticamente desde facturas de proveedores y clientes<br/>
                • Integra gastos periódicos automáticamente<br/>
                • Analiza variaciones entre proyectado y real<br/>
            </p>
        </field>
    </record>

    <!-- ========================================== -->
    <!-- ACCIÓN PARA CASHFLOW DESDE FACTURAS -->
    <!-- ========================================== -->
    <record id="action_cashflow_from_invoices" model="ir.actions.act_window">
        <field name="name">Cashflow desde Facturas</field>
        <field name="res_model">cashflow.projection</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="domain">[('source_type', 'in', ['supplier_invoice', 'customer_invoice', 'invoice'])]</field>
        <field name="context">{
            'search_default_from_invoices': 1,
            'search_default_current_month': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_empty_folder">
                No hay proyecciones desde facturas
            </p>
            <p>
                Las proyecciones desde facturas se crean automáticamente cuando:<br/>
                • Se confirman facturas de proveedores con fechas de vencimiento<br/>
                • Se emiten facturas a clientes pendientes de cobro<br/>
                • Se ejecuta la importación manual desde el dashboard<br/>
            </p>
        </field>
    </record>

    <!-- ========================================== -->
    <!-- ACCIÓN PARA CASHFLOW DESDE GASTOS PERIÓDICOS -->
    <!-- ========================================== -->
    <record id="action_cashflow_from_periodic" model="ir.actions.act_window">
        <field name="name">Cashflow desde Gastos Periódicos</field>
        <field name="res_model">cashflow.projection</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="domain">[('source_type', '=', 'periodic')]</field>
        <field name="context">{
            'search_default_from_periodic': 1,
            'search_default_current_quarter': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_empty_folder">
                No hay proyecciones desde gastos periódicos
            </p>
            <p>
                Las proyecciones desde gastos periódicos se crean automáticamente cuando:<br/>
                • Se activan gastos periódicos con "Auto-crear Proyección Cashflow"<br/>
                • Se ejecuta el proceso automático de generación<br/>
                • Se actualiza la fecha de próximo pago de un gasto periódico<br/>
            </p>
        </field>
    </record>
</odoo>