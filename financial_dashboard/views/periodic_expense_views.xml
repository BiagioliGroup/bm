<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================== -->
    <!-- VISTA LISTA DE GASTOS PERIÓDICOS -->
    <!-- ========================================== -->
    <record id="view_periodic_expense_list" model="ir.ui.view">
        <field name="name">periodic.expense.list</field>
        <field name="model">periodic.expense</field>
        <field name="arch" type="xml">
            <list string="Gastos Periódicos" 
                  decoration-danger="is_overdue" 
                  decoration-warning="days_until_due &lt;= 7 and days_until_due &gt; 0"
                  decoration-success="state == 'paid'"
                  decoration-muted="state in ('cancelled', 'suspended')">
                
                <field name="name"/>
                <field name="partner_id"/>
                <field name="category_id"/>
                <field name="expense_type"/>
                <field name="frequency"/>
                <field name="amount" widget="monetary"/>
                <field name="fiscal_type"/>
                <field name="next_payment_date"/>
                <field name="days_until_due" string="Días"/>
                <field name="monthly_average" widget="monetary" optional="hide"/>
                <field name="state" widget="badge" 
                       decoration-success="state == 'active'"
                       decoration-warning="state == 'pending'"
                       decoration-danger="state == 'suspended'"
                       decoration-muted="state == 'cancelled'"
                       decoration-info="state == 'draft'"/>
                <field name="priority" column_invisible="1"/>
                <field name="is_overdue" column_invisible="1"/>
                <field name="invoice_count" optional="hide"/>
                <field name="payment_count" optional="hide"/>
                
                <!-- BOTONES EN LISTA -->
                <button name="action_mark_paid" type="object" string="Marcar Pagado"
                        icon="fa-check" class="btn-success"
                        invisible="state not in ('pending', 'active')"/>
                <button name="action_create_invoice" type="object" string="Crear Factura"
                        icon="fa-file-text-o" class="btn-primary"
                        invisible="state not in ('active', 'pending')"/>
            </list>
        </field>
    </record>

    <!-- ========================================== -->
    <!-- VISTA KANBAN DE GASTOS PERIÓDICOS -->
    <!-- ========================================== -->
    <record id="view_periodic_expense_kanban" model="ir.ui.view">
        <field name="name">periodic.expense.kanban</field>
        <field name="model">periodic.expense</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state" class="o_kanban_small_column">
                <field name="id"/>
                <field name="name"/>
                <field name="partner_id"/>
                <field name="amount"/>
                <field name="next_payment_date"/>
                <field name="state"/>
                <field name="priority"/>
                <field name="is_overdue"/>
                <field name="days_until_due"/>
                <field name="fiscal_type"/>
                <field name="expense_type"/>
                <field name="frequency"/>
                <field name="monthly_average"/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_card">
                            <div class="oe_kanban_content">
                                <!-- HEADER CON PRIORIDAD -->
                                <div class="oe_kanban_details">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <field name="name"/>
                                            </strong>
                                            <br/>
                                            <span class="o_kanban_record_subtitle">
                                                <field name="partner_id"/>
                                            </span>
                                        </div>
                                        <div class="o_kanban_record_top_right">
                                            <div class="o_priority_star_wrapper">
                                                <field name="priority" widget="priority"/>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- INFORMACIÓN PRINCIPAL -->
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <strong>
                                                <field name="amount" widget="monetary"/>
                                            </strong>
                                            <br/>
                                            <small class="text-muted">
                                                <field name="frequency"/>
                                            </small>
                                        </div>
                                        <div class="col-6 text-end">
                                            <span t-if="record.fiscal_type.raw_value == 'white'" 
                                                  class="badge text-bg-success">Blanco</span>
                                            <span t-if="record.fiscal_type.raw_value == 'black'" 
                                                  class="badge text-bg-dark">Negro</span>
                                            <br/>
                                            <small class="text-muted">
                                                <field name="expense_type"/>
                                            </small>
                                        </div>
                                    </div>

                                    <!-- PROMEDIO MENSUAL -->
                                    <div class="mt-1">
                                        <small class="text-info">
                                            Promedio mensual: <field name="monthly_average" widget="monetary"/>
                                        </small>
                                    </div>

                                    <!-- FECHAS -->
                                    <div class="mt-2">
                                        <div t-if="record.next_payment_date.raw_value">
                                            <i class="fa fa-calendar me-1"/>
                                            <field name="next_payment_date"/>
                                            <span t-if="record.is_overdue.raw_value" 
                                                  class="badge text-bg-danger ms-2">Vencido</span>
                                            <span t-if="record.days_until_due.raw_value &lt;= 7 and record.days_until_due.raw_value &gt; 0" 
                                                  class="badge text-bg-warning ms-2">
                                                <t t-esc="record.days_until_due.raw_value"/> días
                                            </span>
                                        </div>
                                    </div>

                                    <!-- BOTONES DE ACCIÓN -->
                                    <div class="mt-3">
                                        <button name="action_mark_paid" type="object" 
                                                class="btn btn-sm btn-success me-2"
                                                invisible="state not in ('pending', 'active')">
                                            <i class="fa fa-check"/> Pagado
                                        </button>
                                        <button name="action_create_invoice" type="object" 
                                                class="btn btn-sm btn-info me-2"
                                                invisible="state not in ('active', 'pending')">
                                            <i class="fa fa-file-text-o"/> Factura
                                        </button>
                                        <button name="action_activate" type="object" 
                                                class="btn btn-sm btn-primary"
                                                invisible="state != 'draft'">
                                            <i class="fa fa-play"/> Activar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ========================================== -->
    <!-- VISTA FORMULARIO DE GASTOS PERIÓDICOS -->
    <!-- ========================================== -->
    <record id="view_periodic_expense_form" model="ir.ui.view">
        <field name="name">periodic.expense.form</field>
        <field name="model">periodic.expense</field>
        <field name="arch" type="xml">
            <form string="Gasto Periódico">
                <header>
                    <button name="action_activate" type="object" string="Activar" 
                            class="btn-primary" invisible="state != 'draft'"/>
                    <button name="action_mark_paid" type="object" string="Marcar como Pagado" 
                            class="btn-success" invisible="state not in ('pending', 'active')"/>
                    <button name="action_create_invoice" type="object" string="Crear Factura" 
                            class="btn-info" invisible="state not in ('active', 'pending')"/>
                    <button name="action_suspend" type="object" string="Suspender" 
                            class="btn-secondary" invisible="state not in ('active', 'pending')"/>
                    <button name="action_view_invoices" type="object" string="Ver Facturas" 
                            class="btn-light" invisible="invoice_count == 0"/>
                    <field name="state" widget="statusbar" 
                           statusbar_visible="draft,active,pending,paid"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" type="object" name="action_view_invoices"
                                icon="fa-file-text-o" invisible="invoice_count == 0">
                            <field string="Facturas" name="invoice_count" widget="statinfo"/>
                        </button>
                        <button class="oe_stat_button" type="object" name="action_view_cashflow_projections" icon="fa-line-chart">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Proyecciones</span>
                                <span class="o_stat_text">Cashflow</span>
                            </div>
                        </button>

                    </div>

                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Descripción del gasto..."/>
                        </h1>
                    </div>
                    
                    <group>
                        <group name="basic_info" string="Información Básica">
                            <field name="partner_id"/>
                            <field name="category_id"/>
                            <field name="expense_type"/>
                            <field name="fiscal_type"/>
                        </group>
                        <group name="amounts" string="Montos y Periodicidad">
                            <field name="amount"/>
                            <field name="monthly_average" readonly="1"/>
                            <field name="currency_id" column_invisible="1"/>
                            <field name="frequency"/>
                            <field name="priority"/>
                        </group>
                    </group>

                    <group>
                        <group name="dates" string="Fechas">
                            <field name="start_date"/>
                            <field name="next_payment_date" readonly="1"/>
                            <field name="last_payment_date"/>
                        </group>
                        <group name="config" string="Configuración">
                            <field name="auto_generate_invoice"/>
                            <field name="auto_create_cashflow"/>
                            <field name="journal_id"/>
                            <field name="account_id"/>
                            <field name="alert_days"/>
                        </group>
                    </group>

                    <group name="status" string="Estado Actual" invisible="state == 'draft'">
                        <field name="is_overdue"/>
                        <field name="days_until_due"/>
                        <field name="payment_count" string="Pagos Realizados"/>
                    </group>

                    <notebook>
                        <page string="Control Mensual" name="monthly_control">
                            <field name="monthly_control_ids" mode="list">
                                <list string="Control por Mes" 
                                      decoration-danger="is_late" 
                                      decoration-success="state == 'paid'"
                                      decoration-warning="state == 'invoice_received'"
                                      editable="bottom">
                                    <field name="month_date"/>
                                    <field name="expected_amount" widget="monetary"/>
                                    <field name="actual_amount" widget="monetary"/>
                                    <field name="difference" widget="monetary" readonly="1"/>
                                    <field name="invoice_date"/>
                                    <field name="payment_date"/>
                                    <field name="due_date"/>
                                    <field name="state" widget="badge"/>
                                    <field name="is_late" column_invisible="1"/>
                                    
                                    <!-- BOTONES EN LÍNEAS -->
                                    <button name="action_mark_invoice_received" type="object"
                                            icon="fa-file-text-o" string="Factura Recibida"
                                            invisible="state != 'pending'"/>
                                    <button name="action_mark_paid" type="object"
                                            icon="fa-check" string="Marcar Pagado"
                                            invisible="state == 'paid'"/>
                                </list>
                            </field>
                        </page>
                        <page string="Historial" name="history">
                            <group>
                                <field name="create_date" readonly="1"/>
                                <field name="create_uid" readonly="1"/>
                                <field name="write_date" readonly="1"/>
                                <field name="write_uid" readonly="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ========================================== -->
    <!-- FILTROS Y BÚSQUEDAS -->
    <!-- ========================================== -->
    <record id="view_periodic_expense_search" model="ir.ui.view">
        <field name="name">periodic.expense.search</field>
        <field name="model">periodic.expense</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="partner_id"/>
                <field name="category_id"/>
                
                <!-- FILTROS PREDEFINIDOS -->
                <filter name="active" string="Activos" domain="[('state', '=', 'active')]"/>
                <filter name="pending" string="Pendientes" domain="[('state', '=', 'pending')]"/>
                <filter name="overdue" string="Vencidos" domain="[('is_overdue', '=', True)]"/>
                <filter name="due_soon" string="Próximos a Vencer" 
                        domain="[('days_until_due', '&lt;=', 7), ('days_until_due', '&gt;', 0)]"/>
                <separator/>
                <filter name="white" string="En Blanco" domain="[('fiscal_type', '=', 'white')]"/>
                <filter name="black" string="En Negro" domain="[('fiscal_type', '=', 'black')]"/>
                <separator/>
                <filter name="taxes" string="Impuestos" domain="[('expense_type', '=', 'tax')]"/>
                <filter name="professional" string="Honorarios" domain="[('expense_type', '=', 'professional')]"/>
                <filter name="services" string="Servicios" domain="[('expense_type', '=', 'service')]"/>
                <filter name="monthly" string="Mensuales" domain="[('frequency', '=', 'monthly')]"/>
                <separator/>
                <filter name="high_priority" string="Prioridad Alta" domain="[('priority', 'in', ['2', '3'])]"/>
                
                <!-- AGRUPACIONES -->
                <group expand="0" string="Agrupar por">
                    <filter name="group_state" string="Estado" context="{'group_by': 'state'}"/>
                    <filter name="group_partner" string="Proveedor" context="{'group_by': 'partner_id'}"/>
                    <filter name="group_category" string="Categoría" context="{'group_by': 'category_id'}"/>
                    <filter name="group_expense_type" string="Tipo de Gasto" context="{'group_by': 'expense_type'}"/>
                    <filter name="group_frequency" string="Frecuencia" context="{'group_by': 'frequency'}"/>
                    <filter name="group_fiscal_type" string="Tipo Fiscal" context="{'group_by': 'fiscal_type'}"/>
                    <filter name="group_priority" string="Prioridad" context="{'group_by': 'priority'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- ========================================== -->
    <!-- ACCIÓN PRINCIPAL GASTOS PERIÓDICOS -->
    <!-- ========================================== -->
    <record id="action_periodic_expense_list" model="ir.actions.act_window">
        <field name="name">Gastos Periódicos</field>
        <field name="res_model">periodic.expense</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="domain">[]</field>
        <field name="context">{'search_default_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                ¡Configura tus gastos periódicos!
            </p>
            <p>
                Administra impuestos, honorarios profesionales y servicios recurrentes:<br/>
                • Configura frecuencias (semanal, mensual, trimestral, etc.)<br/>
                • Mantén un control detallado mes a mes de cada pago<br/>
                • Genera automáticamente proyecciones en el cashflow<br/>
                • Crea facturas de proveedores automáticamente<br/>
                • Recibe alertas antes de los vencimientos<br/>
            </p>
        </field>
    </record>

    <!-- ========================================== -->
    <!-- VISTAS CATEGORÍAS DE GASTOS -->
    <!-- ========================================== -->
    <record id="view_expense_category_list" model="ir.ui.view">
        <field name="name">expense.category.list</field>
        <field name="model">expense.category</field>
        <field name="arch" type="xml">
            <list string="Categorías de Gastos">
                <field name="name"/>
                <field name="code"/>
                <field name="expense_count"/>
                <field name="total_monthly_amount" widget="monetary"/>
                <field name="default_journal_id" optional="hide"/>
                <field name="default_account_id" optional="hide"/>
                <field name="active"/>
            </list>
        </field>
    </record>

    <record id="view_expense_category_form" model="ir.ui.view">
        <field name="name">expense.category.form</field>
        <field name="model">expense.category</field>
        <field name="arch" type="xml">
            <form string="Categoría de Gasto">
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" type="object" name="action_view_expenses"
                                icon="fa-list" invisible="expense_count == 0">
                            <field string="Gastos" name="expense_count" widget="statinfo"/>
                        </button>
                    </div>
                    
                    <group>
                        <group>
                            <field name="name"/>
                            <field name="code"/>
                            <field name="active"/>
                        </group>
                        <group>
                            <field name="color" widget="color"/>
                            <field name="total_monthly_amount" readonly="1"/>
                            <field name="currency_id" column_invisible="1"/>
                        </group>
                    </group>
                    
                    <group string="Configuración Contable">
                        <field name="default_journal_id"/>
                        <field name="default_account_id"/>
                        <field name="cashflow_category_id"/>
                    </group>
                    
                    <field name="description"/>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_expense_category" model="ir.actions.act_window">
        <field name="name">Categorías de Gastos</field>
        <field name="res_model">expense.category</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Define categorías para tus gastos periódicos
            </p>
            <p>
                Las categorías te permiten organizar y analizar mejor tus gastos recurrentes.
            </p>
        </field>
    </record>
</odoo>