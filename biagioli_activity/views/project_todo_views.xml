<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista Form para To-Dos -->
    <record id="view_project_todo_form" model="ir.ui.view">
        <field name="name">project.todo.form</field>
        <field name="model">project.todo</field>
        <field name="arch" type="xml">
            <form string="To-Do">
                <header>
                    <button name="action_mark_done" 
                            string="Marcar como Completado" 
                            type="object" 
                            class="btn-primary"
                            invisible="state in ['done', 'cancelled']"/>
                    <button name="action_mark_in_progress" 
                            string="En Progreso" 
                            type="object"
                            invisible="state != 'open'"/>
                    <button name="action_reopen" 
                            string="Reabrir" 
                            type="object"
                            invisible="state not in ['done', 'cancelled']"/>
                    <button name="action_cancel" 
                            string="Cancelar" 
                            type="object"
                            invisible="state in ['done', 'cancelled']"/>
                    <field name="state" widget="statusbar" statusbar_visible="open,in_progress,done"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" 
                                type="object"
                                name="action_view_source_record"
                                invisible="not resource_model or not resource_id"
                                icon="fa-external-link">
                            <div class="o_stat_info">
                                <field name="resource_name" class="o_stat_text"/>
                                <span class="o_stat_text">Origen</span>
                            </div>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Título del To-Do"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="user_ids" widget="many2many_tags"/>
                            <field name="priority" widget="priority"/>
                            <field name="date_deadline"/>
                            <field name="is_overdue" invisible="1"/>
                            <div class="alert alert-danger" 
                                 role="alert" 
                                 invisible="not is_overdue">
                                <i class="fa fa-exclamation-triangle"/> ¡Este to-do está vencido!
                            </div>
                        </group>
                        <group>
                            <field name="activity_id" readonly="1" invisible="not activity_id"/>
                            <field name="resource_model" readonly="1" invisible="not resource_model"/>
                            <field name="resource_id" readonly="1" invisible="not resource_id"/>
                            <field name="date_done" readonly="1" invisible="state != 'done'"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Descripción">
                            <field name="description" placeholder="Agregar una descripción..."/>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>
    
    <!-- Vista List para To-Dos -->
    <record id="view_project_todo_list" model="ir.ui.view">
        <field name="name">project.todo.list</field>
        <field name="model">project.todo</field>
        <field name="arch" type="xml">
            <list string="To-Dos" 
                  decoration-danger="is_overdue"
                  decoration-success="state == 'done'"
                  decoration-muted="state == 'cancelled'">
                <field name="priority" widget="priority" nolabel="1"/>
                <field name="name"/>
                <field name="user_ids" widget="many2many_tags"/>
                <field name="date_deadline"/>
                <field name="state" widget="badge" 
                       decoration-success="state == 'done'"
                       decoration-warning="state == 'in_progress'"
                       decoration-info="state == 'open'"
                       decoration-danger="state == 'cancelled'"/>
                <field name="resource_name" optional="show"/>
                <field name="is_overdue" invisible="1"/>
            </list>
        </field>
    </record>
    
    <!-- Vista Kanban para To-Dos -->
    <record id="view_project_todo_kanban" model="ir.ui.view">
        <field name="name">project.todo.kanban</field>
        <field name="model">project.todo</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state" 
                    class="o_kanban_small_column"
                    quick_create_view="schedule_activity_project_integration.view_project_todo_form">
                <field name="id"/>
                <field name="name"/>
                <field name="user_ids"/>
                <field name="state"/>
                <field name="priority"/>
                <field name="date_deadline"/>
                <field name="color"/>
                <field name="is_overdue"/>
                <field name="resource_name"/>
                <field name="days_until_deadline"/>
                <progressbar field="state" 
                            colors='{"done": "success", "cancelled": "danger", "in_progress": "warning"}'/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_global_click o_kanban_record">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                </div>
                                <div class="o_dropdown_kanban dropdown">
                                    <a role="button" 
                                       class="dropdown-toggle o-no-caret btn" 
                                       data-bs-toggle="dropdown" 
                                       aria-label="Dropdown menu" 
                                       title="Dropdown menu">
                                        <span class="fa fa-ellipsis-v"/>
                                    </a>
                                    <div class="dropdown-menu" role="menu">
                                        <a type="object" 
                                           role="menuitem" 
                                           class="dropdown-item" 
                                           name="action_mark_done"
                                           invisible="state in ['done', 'cancelled']">
                                            Marcar como Completado
                                        </a>
                                        <a type="object" 
                                           role="menuitem" 
                                           class="dropdown-item" 
                                           name="action_reopen"
                                           invisible="state not in ['done', 'cancelled']">
                                            Reabrir
                                        </a>
                                        <a type="delete" 
                                           role="menuitem" 
                                           class="dropdown-item">
                                            Eliminar
                                        </a>
                                        <ul class="oe_kanban_colorpicker" 
                                            data-field="color"/>
                                    </div>
                                </div>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="user_ids" widget="many2many_avatars"/>
                                <div invisible="not resource_name">
                                    <i class="fa fa-link"/> <field name="resource_name"/>
                                </div>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <field name="priority" widget="priority"/>
                                    <span invisible="not date_deadline">
                                        <i class="fa fa-calendar"/>
                                        <field name="date_deadline"/>
                                    </span>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <span class="badge text-bg-danger" 
                                          invisible="not is_overdue">
                                        Vencido
                                    </span>
                                    <span class="badge text-bg-warning" 
                                          invisible="days_until_deadline &lt; 0 or days_until_deadline &gt; 3">
                                        <t t-esc="record.days_until_deadline.value"/> días
                                    </span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>
    
    <!-- Vista Calendar para To-Dos -->
    <record id="view_project_todo_calendar" model="ir.ui.view">
        <field name="name">project.todo.calendar</field>
        <field name="model">project.todo</field>
        <field name="arch" type="xml">
            <calendar string="To-Dos" 
                      date_start="date_deadline" 
                      color="state"
                      mode="month"
                      quick_create="True">
                <field name="name"/>
                <field name="user_ids" avatar_field="avatar_128"/>
                <field name="state"/>
            </calendar>
        </field>
    </record>
    
    <!-- Vista Search para To-Dos -->
    <record id="view_project_todo_search" model="ir.ui.view">
        <field name="name">project.todo.search</field>
        <field name="model">project.todo</field>
        <field name="arch" type="xml">
            <search string="Buscar To-Dos">
                <field name="name" string="To-Do"/>
                <field name="user_ids"/>
                <field name="resource_name"/>
                <separator/>
                <filter string="Mis To-Dos" 
                        name="my_todos" 
                        domain="[('user_ids', 'in', uid)]"/>
                <filter string="Abiertos" 
                        name="open" 
                        domain="[('state', '=', 'open')]"/>
                <filter string="En Progreso" 
                        name="in_progress" 
                        domain="[('state', '=', 'in_progress')]"/>
                <filter string="Completados" 
                        name="done" 
                        domain="[('state', '=', 'done')]"/>
                <separator/>
                <filter string="Vencidos" 
                        name="overdue" 
                        domain="[('is_overdue', '=', True)]"/>
                <filter string="Hoy" 
                        name="today" 
                        domain="[('date_deadline', '=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter string="Esta Semana" 
                        name="this_week" 
                        domain="[
                            ('date_deadline', '&gt;=', (context_today() - relativedelta(days=context_today().weekday())).strftime('%Y-%m-%d')),
                            ('date_deadline', '&lt;=', (context_today() + relativedelta(days=6-context_today().weekday())).strftime('%Y-%m-%d'))
                        ]"/>
                <separator/>
                <filter string="Desde Actividades" 
                        name="from_activities"
                        domain="[('activity_id', '!=', False)]"/>
                <group expand="0" string="Agrupar Por">
                    <filter string="Estado" 
                            name="group_by_state" 
                            context="{'group_by': 'state'}"/>
                    <filter string="Prioridad" 
                            name="group_by_priority" 
                            context="{'group_by': 'priority'}"/>
                    <filter string="Asignado A" 
                            name="group_by_user" 
                            context="{'group_by': 'user_ids'}"/>
                    <filter string="Fecha Límite" 
                            name="group_by_deadline" 
                            context="{'group_by': 'date_deadline'}"/>
                    <filter string="Modelo Origen" 
                            name="group_by_resource_model" 
                            context="{'group_by': 'resource_model'}"/>
                </group>
            </search>
        </field>
    </record>
    
    <!-- Acción principal para To-Dos -->
    <record id="action_project_todo" model="ir.actions.act_window">
        <field name="name">To-Dos</field>
        <field name="res_model">project.todo</field>
        <field name="view_mode">kanban,list,form,calendar</field>
        <field name="context">{'search_default_my_todos': 1, 'search_default_open': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Creá tu primer To-Do
            </p>
            <p>
                Organizá tus tareas y actividades personales.
                Los To-Dos pueden crearse automáticamente desde actividades programadas.
            </p>
        </field>
    </record>
    
    <!-- Menú principal para To-Dos -->
    <menuitem id="menu_project_todo_root"
              name="To-Dos"
              parent="project.menu_main_pm"
              action="action_project_todo"
              sequence="10"/>
</odoo>