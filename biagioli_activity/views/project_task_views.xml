<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extender vista form de project.task -->
    <record id="view_project_task_form_inherit" model="ir.ui.view">
        <field name="name">project.task.form.inherit.activity</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2"/>
        <field name="arch" type="xml">
            <!-- Agregar pesta침a de informaci칩n de origen - SIEMPRE VISIBLE para debug -->
            <xpath expr="//notebook" position="inside">
                <page string="游늶 Info Actividad" name="activity_info">
                    <group>
                        <group string="Origen de Actividad">
                            <field name="is_from_activity"/>
                            <field name="activity_id" readonly="1"/>
                            <field name="resource_model" readonly="1"/>
                            <field name="resource_id" readonly="1"/>
                            <field name="resource_name" readonly="1"/>
                        </group>
                        <group string="Acciones">
                            <button name="action_view_source_record"
                                    type="object"
                                    string="Ver Registro Origen"
                                    class="btn-primary"
                                    invisible="not resource_model or not resource_id"/>
                        </group>
                    </group>
                </page>
            </xpath>
        </field>
    </record>
            
            <!-- Agregar indicador en el header -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" 
                        type="object"
                        name="action_view_source_record"
                        invisible="not is_from_activity"
                        icon="fa-link">
                    <div class="o_stat_info">
                        <field name="resource_name" class="o_stat_text"/>
                        <span class="o_stat_text">Origen</span>
                    </div>
                </button>
            </xpath>
        </field>
    </record>
    
    <!-- Vista list para tareas con informaci칩n de origen -->
    <record id="view_project_task_list_inherit" model="ir.ui.view">
        <field name="name">project.task.list.inherit.activity</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_tree2"/>
        <field name="arch" type="xml">
            <!-- Agregar columnas de origen -->
            <xpath expr="//field[@name='project_id']" position="after">
                <field name="is_from_activity" optional="hide"/>
                <field name="resource_name" optional="show" invisible="not is_from_activity"/>
                <field name="activity_id" optional="hide"/>
            </xpath>
        </field>
    </record>
    
    <!-- Vista kanban con indicador de origen -->
    <record id="view_project_task_kanban_inherit" model="ir.ui.view">
        <field name="name">project.task.kanban.inherit.activity</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_kanban"/>
        <field name="arch" type="xml">
            <!-- Agregar campos necesarios -->
            <xpath expr="//kanban" position="inside">
                <field name="is_from_activity"/>
                <field name="resource_name"/>
                <field name="resource_model"/>
            </xpath>
            
            <!-- Agregar indicador visual en el footer de la tarjeta -->
            <xpath expr="//t[@t-name='card']//footer//div[@class='d-flex align-items-center gap-1']" position="inside">
                <span t-if="record.is_from_activity.raw_value" 
                      class="badge text-bg-info ms-1"
                      t-att-title="'Origen: ' + (record.resource_name.value || 'Actividad')">
                    <i class="fa fa-calendar-o"/>
                </span>
            </xpath>
        </field>
    </record>
    
    <!-- Filtro para tareas creadas desde actividades -->
    <record id="view_project_task_search_inherit" model="ir.ui.view">
        <field name="name">project.task.search.inherit.activity</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_search_form"/>
        <field name="arch" type="xml">
            <!-- Agregar filtro -->
            <xpath expr="//filter[@name='my_tasks']" position="after">
                <separator/>
                <filter string="Desde Actividades" 
                        name="from_activities"
                        domain="[('is_from_activity', '=', True)]"/>
            </xpath>
            
            <!-- Agregar agrupaci칩n -->
            <xpath expr="//group" position="inside">
                <filter string="Modelo Origen" 
                        name="group_by_resource_model"
                        context="{'group_by': 'resource_model'}"/>
            </xpath>
        </field>
    </record>
    
    <!-- Acci칩n para ver tareas creadas desde actividades -->
    <record id="action_project_task_from_activities" model="ir.actions.act_window">
        <field name="name">Tareas desde Actividades</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">kanban,list,form,calendar,pivot,graph</field>
        <field name="domain">[('is_from_activity', '=', True)]</field>
        <field name="context">{'search_default_my_tasks': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay tareas creadas desde actividades todav칤a
            </p>
            <p>
                Las tareas aparecer치n ac치 cuando se programen actividades con un proyecto seleccionado.
            </p>
        </field>
    </record>
    
    <!-- Men칰 para tareas desde actividades -->
    <menuitem id="menu_project_task_from_activities"
              name="Tareas desde Actividades"
              parent="project.menu_projects"
              action="action_project_task_from_activities"
              sequence="5"/>
</odoo>