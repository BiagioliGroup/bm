<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extender vista form de mail.activity -->
    <record id="view_mail_activity_form_inherit" model="ir.ui.view">
        <field name="name">mail.activity.form.inherit.project</field>
        <field name="model">mail.activity</field>
        <field name="inherit_id" ref="mail.mail_activity_view_form_popup"/>
        <field name="arch" type="xml">
            <!-- Agregar campo de proyecto después del tipo de actividad -->
            <xpath expr="//field[@name='activity_type_id']" position="after">
                <field name="project_id" 
                       placeholder="Seleccionar un proyecto (opcional)"
                       options="{'no_create': True}"/>
            </xpath>
            
            <!-- Agregar información sobre qué se va a crear -->
            <xpath expr="//group" position="after">
                <group string="Integración" invisible="not project_id and not create_todo">
                    <field name="create_task" invisible="1"/>
                    <field name="create_todo" invisible="1"/>
                    <div class="alert alert-info" role="alert" invisible="not create_task">
                        <i class="fa fa-info-circle"/> Se creará una tarea en el proyecto seleccionado
                    </div>
                    <div class="alert alert-info" role="alert" invisible="not create_todo">
                        <i class="fa fa-info-circle"/> Se creará un to-do para esta actividad
                    </div>
                </group>
                
                <!-- Mostrar enlaces a elementos creados -->
                <group string="Elementos Creados" invisible="not linked_task_id and not linked_todo_id">
                    <field name="linked_task_id" readonly="1" invisible="not linked_task_id"/>
                    <field name="linked_todo_id" readonly="1" invisible="not linked_todo_id"/>
                </group>
            </xpath>
        </field>
    </record>
    
    <!-- Vista tree/list para actividades con información de proyecto -->
    <record id="view_mail_activity_list_inherit" model="ir.ui.view">
        <field name="name">mail.activity.list.inherit.project</field>
        <field name="model">mail.activity</field>
        <field name="inherit_id" ref="mail.mail_activity_view_tree"/>
        <field name="arch" type="xml">
            <!-- Agregar columna de proyecto -->
            <xpath expr="//field[@name='user_id']" position="after">
                <field name="project_id" optional="show"/>
                <field name="linked_task_id" optional="hide"/>
                <field name="linked_todo_id" optional="hide"/>
            </xpath>
        </field>
    </record>
    
    <!-- Vista kanban para actividades con indicador de proyecto -->
    <record id="view_mail_activity_kanban_inherit" model="ir.ui.view">
        <field name="name">mail.activity.kanban.inherit.project</field>
        <field name="model">mail.activity</field>
        <field name="inherit_id" ref="mail.mail_activity_view_kanban"/>
        <field name="arch" type="xml">
            <!-- Agregar campos necesarios -->
            <xpath expr="//kanban" position="inside">
                <field name="project_id"/>
                <field name="linked_task_id"/>
                <field name="linked_todo_id"/>
            </xpath>
            
            <!-- Agregar indicador visual en las tarjetas -->
            <xpath expr="//div[hasclass('oe_kanban_content')]" position="inside">
                <div class="o_kanban_record_bottom">
                    <div class="oe_kanban_bottom_left">
                        <span invisible="not project_id" 
                              class="badge text-bg-primary">
                            <i class="fa fa-folder"/> <field name="project_id"/>
                        </span>
                        <span invisible="not linked_task_id" 
                              class="badge text-bg-success">
                            <i class="fa fa-tasks"/> Task
                        </span>
                        <span invisible="not linked_todo_id" 
                              class="badge text-bg-info">
                            <i class="fa fa-check-square-o"/> To-Do
                        </span>
                    </div>
                </div>
            </xpath>
        </field>
    </record>
    
    <!-- Acción para ver actividades con proyectos -->
    <record id="action_mail_activity_with_project" model="ir.actions.act_window">
        <field name="name">Actividades con Proyectos</field>
        <field name="res_model">mail.activity</field>
        <field name="view_mode">kanban,list,form,calendar</field>
        <field name="domain">[('project_id', '!=', False)]</field>
        <field name="context">{'search_default_my_activities': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay actividades vinculadas a proyectos todavía
            </p>
            <p>
                Programá actividades y vincularlas a proyectos para crear tareas automáticamente.
            </p>
        </field>
    </record>
    
    <!-- Menú para actividades con proyectos -->
    <menuitem id="menu_mail_activity_with_project"
              name="Actividades con Proyectos"
              parent="project.menu_main_pm"
              action="action_mail_activity_with_project"
              sequence="15"/>
</odoo>