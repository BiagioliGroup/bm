<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <!-- üõ†Ô∏è Tabla de compatibilidad vehicular -->
  <template id="sh_supported_vehicles" inherit_id="website_sale.product" active="True" customize_show="True" name="Supported Vehicles">
    <xpath expr="//div[@id='product_detail_main']" position="after">
      <div class="tab-pane" id="sh_supported" role="tabpanel">
        <section class="container">
          <div class="row">
            <div t-if="not sh_is_common_product" class="col-lg-12">
              <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 5px;">
                <table class="table table-striped table-sm table-hover mb-0">
                  <thead>
                    <tr><th colspan="3" class="text-center">Compatible con:</th></tr>
                    <tr><th>Marca</th><th>Modelo</th><th>A√±o</th></tr>
                  </thead>
                  <tbody>
                    <t t-if="vehicles" t-foreach="vehicles" t-as="vehicle">
                      <tr>
                        <td><t t-if="vehicle.make_id" t-esc="vehicle.make_id.name"/></td>
                        <td><t t-if="vehicle.mmodel_id" t-esc="vehicle.mmodel_id.name"/></td>
                        <td><t t-if="vehicle.year" t-esc="vehicle.year"/></td>
                      </tr>
                    </t>
                  </tbody>
                </table>
              </div>
            </div>
            <div t-if="sh_is_common_product" class="col-lg-12">
              <div class="alert alert-success text-center">
                <strong>Este producto es compatible con todos los vehiculos</strong>
              </div>
            </div>
          </div>
        </section>
      </div>
    </xpath>
  </template>

  <!-- ‚úÖ Mantener filtros de moto -->
  <template id="products_attributes" inherit_id="website_sale.products_attributes" customize_show="False" active="True" name="Keep Motorcycle Attributes and Variants filters">
    <xpath expr="//input[@name='category']" position="after">
      <input t-if="not website.sh_do_not_consider_vehicle_over_attribute and motorcycle_type" type="hidden" name="type" t-att-value="motorcycle_type"/>
      <input t-if="not website.sh_do_not_consider_vehicle_over_attribute and motorcycle_make" type="hidden" name="make" t-att-value="motorcycle_make"/>
      <input t-if="not website.sh_do_not_consider_vehicle_over_attribute and motorcycle_model" type="hidden" name="model" t-att-value="motorcycle_model"/>
      <input t-if="not website.sh_do_not_consider_vehicle_over_attribute and motorcycle_year" type="hidden" name="year" t-att-value="motorcycle_year"/>
    </xpath>
  </template>


<template id="override_motorcycle_search" inherit_id="website_sale.products" name="Complete motorcycle search optimized">
    <xpath expr="//div[contains(@class,'oe_website_sale')]" position="before">

        <!-- üî≤ Container optimizado -->
        <section class="container-fluid bg-light py-3 mb-3">
            <div class="container">
                
                <!-- üöò FASE 1: Cuando NO hay veh√≠culo seleccionado -->
                <t t-if="not motorcycle_heading">
                    <div class="text-center mb-3">
                        <h5 class="mb-2 text-muted">Seleccion√° tu Veh√≠culo</h5>
                        <small class="text-muted">Encontr√° repuestos espec√≠ficos para tu moto</small>
                    </div>

                    <form id="id_sh_motorcycle_search_form" action="/shop" method="get">
                        
                        <!-- Container m√°s estrecho en desktop -->
                        <div class="row justify-content-center">
                            <div class="col-12 col-lg-10 col-xl-8">
                                
                                <!-- Campos en l√≠nea horizontal -->
                                <div class="row g-2 mb-3">
                                    <!-- Tipo -->
                                    <div class="col-6 col-md-3">
                                        <select name="type" id="id_sh_motorcycle_type" class="form-select" required="required">
                                            <option value="">Tipo</option>
                                        </select>
                                    </div>

                                    <!-- Marca -->
                                    <div class="col-6 col-md-3">
                                        <select name="make" id="id_sh_motorcycle_make" class="form-select" required="required">
                                            <option value="">Marca</option>
                                        </select>
                                    </div>

                                    <!-- A√±o -->
                                    <div class="col-6 col-md-3">
                                        <select name="year" id="id_sh_motorcycle_year" class="form-select" required="required">
                                            <option value="">A√±o</option>
                                        </select>
                                    </div>

                                    <!-- Modelo -->
                                    <div class="col-6 col-md-3">
                                        <select name="model" id="id_sh_motorcycle_model" class="form-select" required="required">
                                            <option value="">Modelo</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Botones centrados -->
                                <div class="row justify-content-center g-2">
                                    <!-- Bot√≥n Buscar -->
                                    <div class="col-3 col-md-3 col-lg-2">
                                        <button type="submit" class="btn btn-primary w-100" style="background-color: #d2691e; border-color: #d2691e;">
                                            <i class="fa fa-search me-1"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Bot√≥n Mi Garage -->
                                    <t t-if="request.session.uid and website.sh_is_show_garage">
                                        <div class="col-3 col-md-3 col-lg-2">
                                            <div class="dropdown">
                                                <button type="button" id="id_sh_motorcycle_select_saved_bike_btn" 
                                                        class="btn btn-secondary w-100 dropdown-toggle"
                                                        style="background-color: #cd853f; border-color: #cd853f;" 
                                                        data-bs-toggle="dropdown" aria-expanded="false">
                                                    <span class="d-none d-md-inline">Mi Garage</span>
                                                    <span class="d-md-none">Garage</span>
                                                </button>
                                                <ul class="dropdown-menu" id="id_sh_motorcycle_select_saved_bike_div">
                                                    <li><small class="dropdown-item-text text-muted">
                                                        Vehiculos guardados:
                                                    </small></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </t>
                                    
                                    <!-- Bot√≥n Reset -->
                                    <div class="col-3 col-md-2">
                                        <a href="/shop" class="btn btn-outline-secondary btn-sm w-100 d-flex align-items-center justify-content-center" 
                                           title="Ver todos los productos" style="text-decoration: none; height: 42px;">
                                            <i class="fa fa-refresh me-1" style="font-size: 0.9rem;"></i>
                                            <span class="d-none d-md-inline">Reset</span>
                                        </a>
                                    </div>
                                </div>
                                
                            </div>
                        </div>

                    </form>
                </t>

                <!-- üõ† FASE 2: Cuando ya hay veh√≠culo seleccionado -->
                <t t-if="motorcycle_heading">
                    <div class="text-center">
                        <div class="motorcycle_heading_section mb-3">
                            <h4 class="text-center text-primary">
                                Veh√≠culo seleccionado: <b><t t-esc="motorcycle_heading"/></b>
                            </h4>
                        </div>

                        <!-- Botones alineados horizontalmente -->
                        <div class="d-flex justify-content-center align-items-center flex-wrap gap-2">
                            
                            <!-- Bot√≥n Save bike to garage -->
                            <t t-if="request.session.uid and website.sh_is_show_garage">
                                <span id="id_sh_motorcycle_save_bike_to_garage_btn" class="btn ui-link link-primary">
                                    <i class="fa fa-plus"/> Guardar en Mi Garage
                                </span>
                            </t>
                            
                            <!-- Bot√≥n Mi Garage -->
                            <t t-if="request.session.uid and website.sh_is_show_garage">
                                <div class="dropdown">
                                    <button type="button" id="id_sh_motorcycle_select_saved_bike_btn_phase2" 
                                            class="btn btn-secondary dropdown-toggle"
                                            style="background-color: #cd853f; border-color: #cd853f;" 
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                        Mi Garage
                                    </button>
                                    <ul class="dropdown-menu" id="id_sh_motorcycle_select_saved_bike_div_phase2">
                                        <li><small class="dropdown-item-text text-muted">
                                            Cargando veh√≠culos...
                                        </small></li>
                                    </ul>
                                </div>
                            </t>
                            
                            <!-- Bot√≥n Seleccionar veh√≠culo diferente -->
                            <button id="id_sh_motorcycle_select_diff_bike_btn" class="btn btn-outline-secondary">
                                <i class="fa fa-retweet me-1"/> Seleccion√° un veh√≠culo diferente
                            </button>
                            
                            <!-- Separador visual -->
                            <span class="text-muted mx-1">|</span>
                            
                            <!-- Bot√≥n Reset/Mostrar todos -->
                            <a href="/shop" class="btn btn-link btn-sm text-muted" title="Ver todos los productos">
                                <i class="fa fa-refresh me-1"></i>Mostrar todos
                            </a>
                            
                        </div>
                    </div>
                </t>

                <!-- üîÑ FASE 3: Formulario para cambiar veh√≠culo - ACTUALIZADA -->
                <div id="id_sh_motorcycle_search_diff_bike_div" class="container-fluid bg-light py-3 mb-3" style="display:none; position:relative; z-index:5;">
                    <div class="container">
                        
                        <div class="text-center mb-3">
                            <h5 class="mb-2 text-muted">Cambiar Veh√≠culo</h5>
                            <small class="text-muted">Seleccion√° un veh√≠culo diferente</small>
                        </div>

                        <form id="id_sh_motorcycle_search_diff_bike_form" action="/shop" method="get">
                            
                            <!-- Container m√°s estrecho en desktop -->
                            <div class="row justify-content-center">
                                <div class="col-12 col-lg-10 col-xl-8">
                                    
                                    <!-- Campos en l√≠nea horizontal -->
                                    <div class="row g-2 mb-3">
                                        <!-- Tipo -->
                                        <div class="col-6 col-md-3">
                                            <select name="type" class="form-select" required="required">
                                                <option value="">Tipo</option>
                                                <t t-if="type_list">
                                                    <t t-foreach="type_list" t-as="type_dic">
                                                        <option t-att-value="type_dic.get('id')" t-att-selected="type_dic.get('id') == motorcycle_type">
                                                            <t t-esc="type_dic.get('name')"/>
                                                        </option>
                                                    </t>
                                                </t>
                                            </select>
                                        </div>

                                        <!-- Marca -->
                                        <div class="col-6 col-md-3">
                                            <select name="make" class="form-select" required="required">
                                                <option value="">Marca</option>
                                                <t t-if="make_list">
                                                    <t t-foreach="make_list" t-as="make_dic">
                                                        <option t-att-value="make_dic.get('id')" t-att-selected="make_dic.get('id') == motorcycle_make">
                                                            <t t-esc="make_dic.get('name')"/>
                                                        </option>
                                                    </t>
                                                </t>
                                            </select>
                                        </div>

                                        <!-- A√±o -->
                                        <div class="col-6 col-md-3">
                                            <select name="year" class="form-select" required="required">
                                                <option value="">A√±o</option>
                                                <t t-if="year_list">
                                                    <t t-foreach="year_list" t-as="year_item">
                                                        <option t-att-value="year_item" t-att-selected="year_item == motorcycle_year">
                                                            <t t-esc="year_item"/>
                                                        </option>
                                                    </t>
                                                </t>
                                            </select>
                                        </div>

                                        <!-- Modelo -->
                                        <div class="col-6 col-md-3">
                                            <select name="model" class="form-select" required="required">
                                                <option value="">Modelo</option>
                                                <t t-if="model_list">
                                                    <t t-foreach="model_list" t-as="model_dic">
                                                        <option t-att-value="model_dic.get('id')" t-att-selected="model_dic.get('id') == motorcycle_model">
                                                            <t t-esc="model_dic.get('name')"/>
                                                        </option>
                                                    </t>
                                                </t>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Botones centrados -->
                                    <div class="row justify-content-center g-2">
                                        <!-- Bot√≥n Buscar -->
                                        <div class="col-3 col-md-3 col-lg-2">
                                            <button type="submit" class="btn btn-primary w-100" style="background-color: #d2691e; border-color: #d2691e;">
                                                <i class="fa fa-search me-1"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Bot√≥n Cancelar -->
                                        <div class="col-3 col-md-2">
                                            <button type="button" class="btn btn-outline-secondary btn-sm w-100 d-flex align-items-center justify-content-center id_sh_motorcycle_search_diff_bike_close" 
                                                   style="text-decoration: none; height: 42px;">
                                                <i class="fa fa-times me-1" style="font-size: 0.9rem;"></i>
                                                <span class="d-none d-md-inline">Cancelar</span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>

                        </form>
                        
                    </div>
                </div>

            </div>
        </section>

    </xpath>
</template>

  <!-- üè∑Ô∏è Badge mayorista en header -->
  <template id="sh_mayorista_badge_header" inherit_id="website.layout" active="True" name="Mayorista Badge Header">
    <xpath expr="//header[@id='top']" position="inside">
      <t t-if="website.sh_show_user_pricelist_badge and not request.env.user._is_public()">
        <t t-set="user_pricelist" t-value="request.env.user.partner_id.property_product_pricelist"/>
        <t t-if="user_pricelist">
          <div class="position-absolute" style="top: 10px; right: 10px; z-index: 1050;">
            <span class="badge bg-primary me-2">
              <i class="fa fa-star me-1"></i>
              <t t-esc="user_pricelist.name"/>
            </span>
          </div>
        </t>
      </t>
    </xpath>
  </template>

  <!-- üí∞ AGREGAR precios comparativos Y OCULTAR original cuando hay comparativos -->
  <template id="sh_mayorista_add_prices_grid" inherit_id="website_sale.products_item" active="True" name="Add Comparative Prices Grid">
    <!-- Ocultar el precio original cuando hay precios comparativos -->
    <xpath expr="//div[hasclass('product_price')]" position="attributes">
      <attribute name="t-attf-style">{{website.sh_show_comparative_prices and not request.env.user._is_public() and len(product.get_comparative_prices()) > 1 and 'display:none;' or ''}}</attribute>
    </xpath>
    
    <!-- Agregar DESPU√âS del precio original -->
    <xpath expr="//div[hasclass('product_price')]" position="after">
      <t t-if="website.sh_show_comparative_prices and not request.env.user._is_public()">
        <t t-set="comparative_prices" t-value="product.get_comparative_prices()"/>
        <t t-if="len(comparative_prices) > 1">
          <!-- Mostrar precios comparativos cuando hay m√∫ltiples listas diferentes -->
          <div class="sh-price-comparison-wrapper">
            <div class="sh-price-comparison">
              <t t-foreach="comparative_prices" t-as="price_info">
                <div t-att-class="'sh-price-user fw-bold' if price_info['is_user_pricelist'] else 'sh-price-other text-decoration-line-through'">
                  <t t-if="price_info['is_user_pricelist']">
                    <i class="fa fa-check-circle me-1"></i>
                  </t>
                  <span class="sh-price-label small"><t t-esc="price_info['name']"/>:</span>
                  <span class="sh-price-amount">$<t t-esc="'{:,.2f}'.format(price_info['price'])"/></span>
                </div>
              </t>
            </div>
          </div>
        </t>
      </t>
    </xpath>
  </template>  
  

<!-- üí∞ Precios comparativos en p√°gina individual de producto - VERSI√ìN CORREGIDA -->
<template id="sh_mayorista_product_page_prices_minimal" inherit_id="website_sale.product" name="Product Page Comparative Prices Minimal">
  <xpath expr="//h1" position="after">
    <t t-if="request.env.user.has_group('base.group_user')">
      <t t-set="comparatives" t-value="product.get_comparative_prices()"/>
      <t t-if="comparatives and len(comparatives) > 1">
        <div class="small text-muted mb-2">
          <t t-foreach="comparatives" t-as="entry">
            <t t-if="entry.get('is_user_pricelist')">
              <span class="text-success fw-bold">
                <i class="fa fa-check-circle me-1"></i>
                <t t-esc="entry.get('name', 'Tu precio')"/>: $<t t-esc="'{:,.0f}'.format(float(entry.get('price', 0)))"/>
              </span>
            </t>
            <t t-else="">
              <span class="text-decoration-line-through ms-2">
                <t t-esc="entry.get('name', 'Lista')"/>: $<t t-esc="'{:,.0f}'.format(float(entry.get('price', 0)))"/>
              </span>
            </t>
          </t>
        </div>
      </t>
    </t>
  </xpath>
</template>

<!-- üè∑Ô∏è Mostrar c√≥digo de variante en vista de producto -->
  <template id="sh_motorcycle_product_view_inherit" inherit_id="website_sale.product" name="Show default_code before product title">
    <xpath expr="//div[@id='product_details']/h1" position="before">
      <t t-if="product_variant and product_variant.default_code">
        <div id="variant_default_code" class="text-muted small mb-2">
          <strong>C√≥digo:</strong> <span t-esc="product_variant.default_code"/>
        </div>
      </t>
    </xpath>
  </template>



<!-- üè∑Ô∏è Mostrar c√≥digo de producto en grid -->
  <template id="sh_motorcycle_products_item_inherit" inherit_id="website_sale.products_item" name="Add default_code to product card (grid and list)">
    <xpath expr="//div[contains(@class,'o_wsale_product_information_text')]" position="before">
      <t t-if="product.default_code">
        <small class="text-muted d-block">C√≥digo: <t t-esc="product.default_code"/></small>
      </t>
    </xpath>


    <!-- Inserta el badge ¬´En stock¬ª sobre la imagen -->
    <xpath expr="//div[contains(@class,'oe_product_image')]" position="inside">
        <t t-if="product_qty_display">
            <span class="badge bg-success">
                <t t-esc="product_qty_display"/>
            </span>
            
        </t>

    </xpath>
  </template>   


<!-- TRABAJO SOBRE CATEGORIAS -->
<!-- TRABAJO SOBRE CATEGORIAS -->
<!-- TRABAJO SOBRE CATEGORIAS -->

<!-- üìÇ Mejoras en las categor√≠as para mostrar filtrado por veh√≠culo -->
<template id="enhanced_categories_with_vehicle_filter" inherit_id="website_sale.products_categories" name="Enhanced Categories with Vehicle Filter">
    
    <!-- Agregar indicador de filtro activo -->
    <xpath expr="//div[hasclass('o_categories_collapse_title')]" position="after">
        <t t-if="has_vehicle_filter and motorcycle_heading">
            <div class="alert alert-info text-center py-2 mb-3">
                <small>
                    <i class="fa fa-filter me-1"></i>
                    Categor√≠as compatibles con: <strong t-esc="motorcycle_heading"/>
                </small>
            </div>
        </t>
    </xpath>
    
    <!-- Agregar contador de productos por categor√≠a si es necesario -->
    <xpath expr="//a[hasclass('nav-link')]" position="inside">
        <t t-if="has_vehicle_filter">
            <!-- Badge sutil para mostrar que la categor√≠a tiene productos para este veh√≠culo -->
            <span class="badge badge-light ms-2 category-vehicle-compatible" style="font-size: 0.7em;">
                <i class="fa fa-check text-success"></i>
            </span>
        </t>
    </xpath>

</template>

<!-- üéØ Snippet para mostrar categor√≠as destacadas por veh√≠culo -->
<template id="vehicle_compatible_categories_snippet" name="Vehicle Compatible Categories">
    <section class="s_vehicle_categories mt-3 mb-4">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h3 class="text-center mb-4">
                        <t t-if="motorcycle_heading">
                            Categor√≠as disponibles para <span class="text-primary" t-esc="motorcycle_heading"/>
                        </t>
                        <t t-else="">
                            Todas las categor√≠as
                        </t>
                    </h3>
                </div>
            </div>
            
            <t t-if="filtered_categories">
                <div class="row">
                    <t t-foreach="filtered_categories.filtered(lambda c: not c.parent_id)[:8]" t-as="category">
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <a t-attf-href="/shop/category/#{category.slug}-#{category.id}" 
                               class="card h-100 text-decoration-none category-card-link">
                                <div class="card-body text-center">
                                    <t t-if="category.image_1920">
                                        <img t-attf-src="/web/image/product.public.category/#{category.id}/image_128" 
                                             class="img-fluid mb-2" 
                                             style="max-height: 64px;"
                                             t-att-alt="category.name"/>
                                    </t>
                                    <t t-else="">
                                        <i class="fa fa-folder-o fa-3x mb-2 text-muted"></i>
                                    </t>
                                    <h5 class="card-title" t-esc="category.name"/>
                                    <small class="text-muted">
                                        <t t-if="has_vehicle_filter">
                                            Compatible con tu veh√≠culo
                                        </t>
                                        <t t-else="">
                                            Ver todos los productos
                                        </t>
                                    </small>
                                </div>
                            </a>
                        </div>
                    </t>
                </div>
            </t>
            
            <t t-else="">
                <div class="row">
                    <div class="col-12 text-center">
                        <div class="alert alert-warning">
                            <i class="fa fa-exclamation-triangle"></i>
                            No hay categor√≠as espec√≠ficas para este veh√≠culo.
                            <br/>
                            <a href="/shop" class="btn btn-outline-primary mt-2">
                                Ver todos los productos
                            </a>
                        </div>
                    </div>
                </div>
            </t>
        </div>
    </section>
</template>

<!-- üé® CSS espec√≠fico para las categor√≠as filtradas -->
<template id="vehicle_categories_styles">
    <style>
        /* Estilos para categor√≠as compatibles con veh√≠culo */
        .category-vehicle-compatible {
            animation: pulse-green 2s infinite;
        }
        
        @keyframes pulse-green {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .category-card-link {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .category-card-link:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-decoration: none;
        }
        
        .s_vehicle_categories .card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        
        .s_vehicle_categories .card:hover {
            border-color: var(--bs-primary);
        }
        
        /* Indicador de filtro activo m√°s sutil */
        .alert.py-2 {
            border-radius: 6px;
            border-left: 4px solid var(--bs-info);
        }
    </style>
</template>

</odoo>